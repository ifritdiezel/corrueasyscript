<!DOCTYPE html>
<meta content="corru dialogue generator" property="og:title" />
<meta content="write custom scripts easily" property="og:description" />

<h2>corru script generator</h2>
<p>paste a script from a discord skit with the embassy server custom emoji</p>
<p>or use actors as <code>moth: lol</code>. no actor makes sourceless text. if you're using a colon in sourceless text escape it with a backslash</p>
<p>then hit the copy button and just paste the result into the console on any corru.observer page!</p>
<p>scroll all the way down for various info and tools!</p>


<p>powered by <a href="https://file.garden/ZdYqv9vlqFbDy9iO/DIALOGUE_TOOLKIT%202.0%20credits%20to%20dem%20for%20organizing%20it.js">this script</a>, made by @noobogonis and @the_dem</p>

<button type="button" name="copy script" onclick="copyScript()">copy script</button>
<button type="button" name="copy dialogue only" onclick="copyDialogueOnly()">copy dialogue only</button>
<p id="element_status"></p>
<br>
<textarea id="userinput" name="w3review" rows="100" cols="200" placeholder=":moth: lol&#10;endbutton: ok">
</textarea>

<br>
<p>inherited context example: <xmp><span definition="INHERITED CONTEXT::'predator';'infection';'terror'">secri</span></xmp></p>
<p>automatically add inherited context to text</p>
<input type="text" name="contextifierType" id="contextifierType" value="INHERITED CONTEXT">
<input type="text" name="contextifierWord" id="contextifierWord" placeholder="secri">
<input type="text" name="contextifierContexts" id="contextifierContexts" placeholder="predator; infection; terror">
<button type="button" name="useContextifier" onclick="useContextifier()">replace!</button>
<button type="button" name="undoContextifier" onclick="undoContextifier()">nevermind, undo</button>
<input type="checkbox" id="contextifierCaps" name="contextifierCaps" value=contextifierCaps checked=true>
<label for="contextifierCaps">repeat for caps text too</label>
<br>

<p>mass replacer tool</p>
<input type="text" name="massReplacerFrom" id="massReplacerFrom" placeholder="from">
<input type="text" name="massReplacerTo" id="massReplacerTo" placeholder="to">
<button type="button" name="massReplacerReplace" onclick="useMassReplacer()">replace!</button>
<button type="button" name="massReplacerUndo" onclick="undoMassReplace()">wait! undo please!</button>
<input type="checkbox" id="replacerCaps" name="replacerCaps" value=replacerCaps>
<label for="replacerCaps">repeat for caps text too</label>
<br>

<script type="text/javascript">
	let actorLoadingScript = ""; //only retrieved once per page reload
	let actorDump = "envoy";

	async function copyDialogueOnly() {copyScript(true)}

	async function copyScript(dialogueOnly){

		let actorInit = "";
		let dialogueBody = "";
		let scriptBody = "";

		if (!actorLoadingScript) try {
			element_status.innerHTML = "now retrieving the actor setup script...";
			await fetch('https://file.garden/ZdYqv9vlqFbDy9iO/DIALOGUE_TOOLKIT%202.0%20credits%20to%20dem%20for%20organizing%20it.js')
			.then(response => response.text())
			.then((data) => {
				let isAtActorDefs = false;
				let isListingActors = true;
				for (line of data.split("\n")){
					if (line.includes("////////// DIALOGUE ACTORS //////////")) isAtActorDefs = true;
					if (line.includes("////////// DIALOGUE OBJECT //////////")) isListingActors = false;
					if (line.includes("MOD LOAD")) break;
					if (isAtActorDefs) actorLoadingScript += line + "\n";
					if (isListingActors) actorDump += line + "\n";
				}
			})
		} catch (e){
			element_status.innerHTML = "oh no! an error occured retrieving the actor script! please notify me, @ifritdiezel!";
			console.log(e);
			return;
		}

		if (!actorLoadingScript) {
			element_status.innerHTML = "oh no! an error occured retrieving the actor script! please notify me, @ifritdiezel!";
			return;
		}

		actorInit += actorLoadingScript;

		userInput = document.getElementById('userinput').value;

		dialogueBody += '\n\nenv.dialogues["customScript"] = generateDialogueObject(`\nstart';

		previousSpeaker = "";
		currentSpeaker = "";
		unfoundSpeakers = [];
		hasEndButton = false;
		for (line of userInput.split('\n')){
			if (!line) continue;
			currentSpeaker = "";
			args = line.split(' ');
			let speechValue = "";

			if (line.includes(':')){
				line = line.replaceAll("\\:", "%%TEMP2%%");
				line = line.replaceAll("::", "%%TEMP3%%");
				if (line.startsWith(":")) line = line.replace(":", "");

				if (line.includes(":")) {
					line = line.replace(":", "%%TEMP%%");
					line = line.replaceAll("%%TEMP3%%", "::");
					currentSpeaker = line.split("%%TEMP%%")[0];
				}
				else currentSpeaker = "sourceless";
				speechValue = line.split("%%TEMP%%")[1] || "​"; //there's a zero width space here to make empty messages
				if (currentSpeaker == "sourceless") speechValue = line;
				currentSpeaker = currentSpeaker.split("~")[0];

				speechValue = speechValue.replaceAll("%%TEMP2%%", ":");
				currentSpeaker = currentSpeaker.replaceAll("%%TEMP2%%", ":");

			}
			else {
				currentSpeaker = "sourceless";
				speechValue = line;
			}
			if (currentSpeaker.toLowerCase().startsWith("endbutton")){
				hasEndButton = true;
				dialogueBody += "\n    \n";
				dialogueBody += "    RESPONSES::self\n";
				dialogueBody += "        " + speechValue +"<+>END"
			}
			else if (currentSpeaker){
				if (!speechValue) speechValue = " ";
				currentSpeaker = speakerMap[currentSpeaker] || currentSpeaker;
				if (currentSpeaker != previousSpeaker) {
					if (previousSpeaker) dialogueBody += "\n";
					dialogueBody += "\n";
					dialogueBody += "    "+currentSpeaker;
				}
				dialogueBody += "\n";
				dialogueBody += "        " + speechValue;

				previousSpeaker = currentSpeaker;

				if (!unfoundSpeakers.includes(currentSpeaker.split('::')[0]) && !actorDump.includes(currentSpeaker.split('::')[0])) unfoundSpeakers.push(currentSpeaker);
			}
			else {
				console.log("error in line " + line)
			}
		}

		if (!hasEndButton){
			dialogueBody += "\n    \n";
			dialogueBody += "    RESPONSES::self\n";
			dialogueBody += "        end<+>END"
		}

		dialogueBody += '\n`)';

		//i hate this thing leave me aloneg
		dialogueBody = dialogueBody.replaceAll("%%TEMP%%", ":");
		dialogueBody = dialogueBody.replaceAll("%%TEMP2%%", ":");
		dialogueBody = dialogueBody.replaceAll("%%TEMP3%%", "::");

		scriptBody += "startDialogue('customScript')"

		if (dialogueOnly) navigator.clipboard.writeText(dialogueBody + "\n\n" + scriptBody);
		else navigator.clipboard.writeText(actorInit + "\n\n" + dialogueBody + "\n\n" + scriptBody);
		if (unfoundSpeakers.length > 0) element_status.innerHTML = "hey! i don't see " + unfoundSpeakers.join(", ") + " in the list of actors! are you sure they're correct!";
		else element_status.innerHTML = "script copied!";
	}

	let preReplace = "";
	function useMassReplacer(){
		let from = document.getElementById('massReplacerFrom').value;
		let to = document.getElementById('massReplacerTo').value;
		let userInput = document.getElementById('userinput').value;
		preReplace = userInput;
		preContextify = "";
		userInput = userInput.replaceAll(from, to);
		if (document.getElementById('replacerCaps').checked) userInput = userInput.replaceAll(from.toUpperCase(), to.toUpperCase());

		document.getElementById('userinput').value = userInput;

	}
	function undoMassReplace(){
		if (preReplace) document.getElementById('userinput').value = preReplace;
	}

	let preContextify = "";
	function useContextifier(){
		let word = document.getElementById('contextifierWord').value;
		let contexts = document.getElementById('contextifierContexts').value;
		if (!word || !contexts) return;
		let type = document.getElementById('contextifierType').value;
		let userInput = document.getElementById('userinput').value;
		preContextify = userInput;
		preReplace = "";
		let quotifiedContexts =[];
		for (context of contexts.split(";")){
			if (context.endsWith("'") && context.startsWith("'")) quotifiedContexts.push(context.trim());
			else quotifiedContexts.push("'"+ context.trim()+"'");
		}
		let finalContextsString = quotifiedContexts.join(";");

		//mask away all words that already have contexts
		userInput = userInput.replaceAll(`'">${word}</span>`, "%%TEMP4%%")
		userInput = userInput.replaceAll(`'">${word.toUpperCase()}</span>`, "%%TEMP4_1%%")

		userInput = userInput.replaceAll(word, `<span definition="${type}::${finalContextsString}">${word}</span>`);
		if (document.getElementById('contextifierCaps').checked) userInput = userInput.replaceAll(word.toUpperCase(), `<span definition="${type}::${finalContextsString}">${word.toUpperCase()}</span>`);

		userInput = userInput.replaceAll("%%TEMP4%%", `'">${word}</span>`);
		userInput = userInput.replaceAll("%%TEMP4_1%%", `'">${word.toUpperCase()}</span>`);

		document.getElementById('userinput').value = userInput;

	}
	function undoContextifier(){
		if (preContextify) document.getElementById('userinput').value = preContextify;
	}

	const speakerMap={
		"interloper":"self",
		"velzie":"unknown",
		"memory hole":"¥Óñ«J",
		"vekoa":"groundsmind",
		"proxy":"sys",
		"geliblueeyes": "geli::blueeyes",
		"geliconcern": "geli::concern",
		"gelihappy": "geli::happy",
		"gelithink": "geli::think",
		"geliuncanny": "geli::uncanny",
		"bsteliblueeyes": "bsteli::blueeyes",
		"bsteliconcern": "bsteli::concern",
		"bstelihappy": "bsteli::happy",
		"bstelithink": "bsteli::think",
		"bsteliuncanny": "bsteli::uncanny",
		"gordon":"envoy"
	}

</script>
